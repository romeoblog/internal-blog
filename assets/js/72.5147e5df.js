(window.webpackJsonp=window.webpackJsonp||[]).push([[72],{784:function(e,a,s){"use strict";s.r(a);var t=s(97),n=Object(t.a)({},(function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"mysql集群主从复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql集群主从复制"}},[e._v("#")]),e._v(" mysql集群主从复制")]),e._v(" "),s("h2",{attrs:{id:"准备两台安装好的mysql服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备两台安装好的mysql服务器"}},[e._v("#")]),e._v(" 准备两台安装好的mysql服务器:")]),e._v(" "),s("p",[s("strong",[e._v("192.168.3.23 (master)")])]),e._v(" "),s("p",[s("strong",[e._v("192.168.3.25 (slave)")])]),e._v(" "),s("h2",{attrs:{id:"配置主服务-master-添加如下配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置主服务-master-添加如下配置"}},[e._v("#")]),e._v(" 配置主服务(master), 添加如下配置")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("vi")]),e._v(" /etc/my.cnf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 节点唯一id值")]),e._v("\nserver-id"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 开启二进制日志")]),e._v("\nlog-bin"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("mysql-bin\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 指定日志格式 有mixed|row|statement 推荐mixed")]),e._v("\nbinlog-format"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("mixed\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 步进值auto_imcrement。一般有n台主MySQL就填n(可选配置)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("auto_increment_increment")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 起始值。一般填第n台主MySQL。此时为第一台主MySQL(可选配置)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("auto_increment_offset")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 忽略mysql库(可选配置)")]),e._v("\nbinlog-ignore-db"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("mysql\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 忽略information_schema库(可选配置)")]),e._v("\nbinlog-ignore-db"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("information_schema\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 要同步的数据库，默认所有库(可选配置)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#replicate-do-db=test_db")]),e._v("\n\n")])])]),s("h2",{attrs:{id:"配置从服务-slave-添加如下配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置从服务-slave-添加如下配置"}},[e._v("#")]),e._v(" 配置从服务(slave), 添加如下配置")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("# 节点唯一id值\nserver-id=2\n\n# 开启二进制日志\nlog-bin=mysql-bin\n\n# 步进值auto_imcrement。一般有n台主MySQL就填n(可选配置)\nauto_increment_increment=2\n\n# 起始值。一般填第n台主MySQL。此时为第一台主MySQL(可选配置)\nauto_increment_offset=2\n\n# 要同步的数据库，默认所有库(可选配置)\n#replicate-do-db=test_db\n\n")])])]),s("h2",{attrs:{id:"重启-mysql-两个节点都重启"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重启-mysql-两个节点都重启"}},[e._v("#")]),e._v(" 重启 mysql, 两个节点都重启")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("\n[root@mysql8 ~]# service mysqld restart\nShutting down MySQL............ SUCCESS! \nStarting MySQL.... SUCCESS!\n\n")])])]),s("h2",{attrs:{id:"在主节点查看-master-的状态-尤其是当前的日志及位置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在主节点查看-master-的状态-尤其是当前的日志及位置"}},[e._v("#")]),e._v(" 在主节点查看 master 的状态 , 尤其是当前的日志及位置")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("mysql> show master status;\n+------------------+----------+--------------+--------------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB         | Executed_Gtid_Set |\n+------------------+----------+--------------+--------------------------+-------------------+\n| mysql-bin.000013 |      155 |              | mysql,information_schema |                   |\n+------------------+----------+--------------+--------------------------+-------------------+\n1 row in set (0.00 sec)\n\n\n")])])]),s("h2",{attrs:{id:"在slave节点执行如下命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在slave节点执行如下命令"}},[e._v("#")]),e._v(" 在slave节点执行如下命令")]),e._v(" "),s("p",[e._v("注意master_log_file 是对应show master status;中file的值，master_log_pos是对应position的值")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("mysql> change master to\n    -> master_host='192.168.3.23',\n    -> master_user='root',\n    -> master_password='123456',\n    -> master_log_file='mysql-bin.000013',\n    -> master_log_pos=155;\nQuery OK, 0 rows affected, 2 warnings (0.14 sec)\n")])])]),s("h2",{attrs:{id:"启动-slave-状态-开始监听-msater-的变化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动-slave-状态-开始监听-msater-的变化"}},[e._v("#")]),e._v(" 启动 slave  状态 ( 开始监听 msater 的变化 )")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("mysql> start slave;\nQuery OK, 0 rows affected (0.01 sec)\n\n#重置 slave 状态\n$ reset slave;\n\n#暂停 slave 状态\n$ stop slave;\n\n")])])]),s("h2",{attrs:{id:"查看-slave-的状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看-slave-的状态"}},[e._v("#")]),e._v(" 查看 slave 的状态")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("mysql> show slave status\\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 192.168.3.23\n                  Master_User: root\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000013\n          Read_Master_Log_Pos: 155\n               Relay_Log_File: mysql8-relay-bin.000004\n                Relay_Log_Pos: 322\n        Relay_Master_Log_File: mysql-bin.000013\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: \n          Replicate_Ignore_DB: \n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: \n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 155\n              Relay_Log_Space: 698\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error: \n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 1\n                  Master_UUID: 51c0ac32-817e-11ea-8a8e-000c2923a7d6\n             Master_Info_File: mysql.slave_master_info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0\n         Replicate_Rewrite_DB: \n                 Channel_Name: \n           Master_TLS_Version: \n       Master_public_key_path: \n        Get_master_public_key: 0\n            Network_Namespace: \n1 row in set (0.03 sec)\n\n\n")])])]),s("p",[e._v("当Slave_IO_Running: Yes和Slave_SQL_Running: Yes都为yes是说明主从复制正常")]),e._v(" "),s("h2",{attrs:{id:"问题注意和排查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题注意和排查"}},[e._v("#")]),e._v(" 问题注意和排查")]),e._v(" "),s("p",[e._v("如果启动的时候遇到以下状态，出现的可能是server_id相同，可能是server_UUID相同")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("mysql> show slave status\\G\n*************************** 1. row ***************************\n               Slave_IO_State: \n                  Master_Host: 192.168.3.23\n                  Master_User: root\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000013\n          Read_Master_Log_Pos: 155\n               Relay_Log_File: mysql8-relay-bin.000001\n                Relay_Log_Pos: 4\n        Relay_Master_Log_File: mysql-bin.000013\n             Slave_IO_Running: No\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: \n          Replicate_Ignore_DB: \n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: \n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 155\n              Relay_Log_Space: 155\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        Seconds_Behind_Master: NULL\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 13117\n                Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work.\n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 1\n                  Master_UUID: \n             Master_Info_File: mysql.slave_master_info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: 200419 11:03:37\n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0\n         Replicate_Rewrite_DB: \n                 Channel_Name: \n           Master_TLS_Version: \n       Master_public_key_path: \n        Get_master_public_key: 0\n            Network_Namespace: \n1 row in set (0.00 sec)\n\n")])])]),s("p",[e._v("出现Slave_IO_Running: No错误")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('碰到了"Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs;  these UUIDs must be different for replication to work." 这个错误提示\n')])])]),s("h3",{attrs:{id:"查看server-id是否相同"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看server-id是否相同"}},[e._v("#")]),e._v(" 查看server_id是否相同")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("mysql> show variables like 'server_id';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| server_id     | 1     |\n+---------------+-------+\n1 row in set (0.03 sec)\n\n\nmysql> show variables like 'server_id';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| server_id     | 2     |\n+---------------+-------+\n1 row in set (0.03 sec)\n\n")])])]),s("h3",{attrs:{id:"查看server-uuid是否相同"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看server-uuid是否相同"}},[e._v("#")]),e._v(" 查看server_uuid是否相同")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("# 查看master节点\n[root@mysql8 ~]# cat /usr/local/mysql/data/auto.cnf\n[auto]\nserver-uuid=51c0ac32-817e-11ea-8a8e-000c2923a7d6\n\n# 查看slave节点\n[root@mysql8 ~]# cat /usr/local/mysql/data/auto.cnf\n[auto]\nserver-uuid=51c0ac32-817e-11ea-8a8e-000c2923a7d6\n\n")])])]),s("p",[e._v("经过排查，主从架构中使用了相同的UUID。")]),e._v(" "),s("p",[e._v("原因：我搭建集群是先在虚拟机上搭好主库环境，然后直接克隆镜像当作从库，这样会导致主从库生成相同的server-uuid。只需删除一个server-uuid并重启数据库服务即可解决问题。")])])}),[],!1,null,null,null);a.default=n.exports}}]);